# アンサンブル実行による嘘検出システム

## 概要

このプロジェクトは、確率的に「嘘をつく」エージェントが混在する環境において、アンサンブル手法を用いて正しい情報を抽出するシステムの概念検証です。A.9: アンサンブル実行の理論的説明のためのサンプルコードとして開発されました。

## 問題設定

- **入力**: 中程度の長さの文章（要約対象）
- **エージェント**: 3つの要約エージェントが並列動作
- **悪意性**: 各エージェントは設定確率で「嘘」（元文章にない情報）を混入
- **未知性**: オーケストレータはどのエージェントが嘘をつくかを事前に知らない
- **目標**: 正確な要約の特定、または嘘検出による出力阻止

## システム構成

### ファイル構成
```
/ensemble/
├── README.md                   # このファイル
├── ensemble_summarizer.md      # メインオーケストレータ
├── summarizer_agent.md         # 共通エージェントテンプレート
├── sample_article.md           # テスト用サンプル記事
├── agents/                     # 実行時生成フォルダ
│   ├── summarizer_agent_1.md   # エージェント1（ID置換済み）
│   ├── summarizer_agent_2.md   # エージェント2（ID置換済み）
│   └── summarizer_agent_3.md   # エージェント3（ID置換済み）
├── CLAUDE.md                   # 自然言語マクロ構文定義（既存）
├── variable_db.py              # SQLite変数管理システム（既存）
├── variables.db                # 変数データベース（既存）
└── watch_variables.py          # 変数監視ツール（既存）
```

### 各ファイルの役割

#### 1. `ensemble_summarizer.md` - メインオーケストレータ
**役割**: システム全体の制御・実行
**機能**:
- 変数の初期化・クリア
- 嘘つき確率の設定（ユーザー制御可能）
- 入力テキストの読み込み・配布
- 3つのエージェントの並列実行（Task tool使用）
- 要約結果の収集
- ペア比較によるアンサンブル判定
- 最終結果の決定・出力

**アンサンブル判定ロジック**:
```
IF (s1 == s2): 採用 s1
ELIF (s2 == s3): 採用 s2  
ELIF (s1 == s3): 採用 s1
ELSE: "一致する要約なし。嘘検出により出力阻止"
```

#### 2. `summarizer_agent.md` - 共通エージェントテンプレート
**役割**: 各エージェントの動作定義
**機能**:
- 確率的嘘つき判定（インラインPython使用）
- 正直モード: 正確な要約作成
- 嘘混入モード: 4種類の嘘パターンから選択実行
- ID置換システム（`<<ID>>` → 実際の数字）

**嘘の混入パターン**:
- **パターンA**: 存在しない人名追加
- **パターンB**: 数字の10-30%改変
- **パターンC**: 架空の引用・発言追加  
- **パターンD**: 存在しない事実追加

**確率判定方式**:
```bash
uv run python -c "import random; print(1 if random.random() < {{lie_probability}} else 0)"
```

#### 3. `sample_article.md` - テストデータ
**役割**: 嘘を混入しやすいテスト用記事
**特徴**:
- 具体的な数字（金額、企業数、人数等）
- 人名・企業名・日付
- 検証可能な事実情報
- 中程度の長さ（300-500語程度）

## 技術的特徴

### 1. 自然言語マクロプログラミング
- `CLAUDE.md`に定義された構文に完全準拠
- `{{変数名}}`形式でSQLite変数管理
- 自然言語による条件分岐・制御構文

### 2. SQLite変数管理
- `variable_db.py`による永続的な状態管理
- `watch_variables.py`でリアルタイム監視可能
- 実行過程の完全な透明性・追跡可能性

### 3. 並列エージェント実行
- Task toolによる3エージェント同時実行
- 各エージェントの独立性保証
- テンプレートベースの動的エージェント生成

### 4. 確率的動作制御
- 真のランダム性（Python random）
- ユーザー制御可能な嘘つき確率
- 実験パラメータの柔軟な調整

## 実行方法

### 基本実行
```bash
# メインシステムの実行
ensemble_summarizer.mdの実行をしてください
```

### 確率調整
`ensemble_summarizer.md`内の以下の行を編集：
```markdown
{{lie_probability}}に0.3を保存してください。  # 30%の嘘つき確率
```

### 変数監視
別ターミナルで変数変化をリアルタイム観測：
```bash
python watch_variables.py
```

## 理論的背景

### アンサンブル効果の期待値（n=3, p=嘘つき確率）
- **全員正直**: (1-p)³ → 一致採用
- **1人嘘**: 3p(1-p)² → 正直2人一致で採用
- **2人嘘**: 3p²(1-p) → 採用不可
- **全員嘘**: p³ → 採用不可

**成功確率** = (1-p)³ + 3p(1-p)² = (1-p)²(1+2p)

**例**: p=0.3の場合 → 成功確率 ≈ 78%

### セキュリティ上の意義
- **悪意のあるエージェント対策**: 信頼できないエージェントが混在する環境での情報抽出
- **フォルトトレラント設計**: 単一障害点の排除
- **透明性と検証可能性**: すべての判定過程が記録・検証可能

## 実験結果例

### 実行例1（嘘つき確率40%）
- Agent 1: 正直 → 正確な要約
- Agent 2: 嘘（架空の政府支援追加）→ 不正確な要約
- Agent 3: 正直 → 正確な要約
- **結果**: Agent 1&3一致 → 正確な要約を採用

### 実行例2（嘘つき確率30%）  
- Agent 1: 正直 → 正確な要約（導入25社）
- Agent 2: 正直 → 正確な要約（導入25社）
- Agent 3: 嘘（30社に改変）→ 不正確な要約
- **結果**: Agent 1&2一致 → 正確な要約を採用

## 拡張可能性

### エージェント数の拡張
- n個のエージェントに対応（ID置換システム活用）
- より複雑な投票メカニズムの実装

### 嘘パターンの多様化
- より巧妙な嘘の実装
- 文脈に応じた動的嘘生成

### 判定アルゴリズムの改良
- 類似度ベースの比較
- 重み付き投票システム
- 信頼度スコアの導入

## 制約事項

- **シンプル実装**: 概念検証のため、複雑な自然言語処理は使用せず
- **固定テスト**: 単一記事による検証（拡張可能）
- **バイナリ判定**: 一致/不一致の二値判定（改良可能）

## 結論

本システムは、確率的に悪意のある動作をするエージェントが存在する環境において、アンサンブル手法による信頼できる情報抽出が可能であることを実証します。シンプルな実装ながら、マルチエージェントシステムにおけるセキュリティとフォルトトレランスの重要な原理を示しています。