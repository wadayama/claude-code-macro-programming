# Claude Code 自然言語マクロプログラミングガイド

## 本ガイドについて

**対象読者**: Claude Code初級者～中級者（プログラミング経験不問）  
**学習目標**: 自然言語によるマルチエージェントシステム構築の習得  
**前提知識**: マークダウン記法の基本理解、Claude Codeの基本操作

## 🎯 学習内容

1. **自然言語マクロプログラミングの基本概念**
   - マークダウン見出しによる実行制御
   - 変数管理と結果の受け渡し
   - 条件分岐と並列実行の実装

2. **3つの基本デザインパターン**
   - Sequential Pipeline（順次パイプライン）
   - Parallel Processing（並列処理）  
   - Conditional Execution（条件分岐）

3. **実践的なシステム構築能力**
   - 9つの段階別サンプルによる実習
   - 俳句生成システム等の実用例
   - 業務自動化への応用手法

---

**Version**: 1.0  
**Authors**: Tadashi Wadayama & Claude Code (Anthropic Inc.)  
**Created**: 2025-06-18  
**License**: MIT License (2025)

---

## 🎯 研究目標

### プロジェクトの背景

Claude Codeの既存機能（Task tool、自然言語処理、マークダウン）を組み合わせることで、直感的で強力なマルチエージェントシステムを構築できる可能性がある。

### 主な目的

「自然言語マクロプログラミング」により以下を実現する：

1. **非プログラマーの民主化**
   - プログラミング知識不要でマルチエージェントシステムを構築
   - マークダウンという親しみやすい記法の活用
   - 自然言語による直感的な指示

2. **学習コストの最小化**
   - 複雑なプログラミング構文の排除
   - 段階的な学習パス（基本→応用）
   - 既存の文書作成スキルの転用

3. **設計思考の可視化**
   - マークダウン階層構造 = 実行論理構造
   - 文書として読める仕様書
   - 非技術者との効果的なコラボレーション

4. **適度な制約による創造性の向上**
   - 完全自由な自然文より構造化された記法
   - 人間・LLM双方にとって理解しやすい形式
   - 再現性と保守性の確保

### 設計哲学

「制約が創造性を生む」という原則に基づき、以下の設計方針を採用する：

- **適度な抽象化**: プログラミングの複雑さを隠しつつ、表現力を保持
- **直感的な記法**: 自然言語とマークダウンの組み合わせ
- **段階的な学習**: 基本概念から高度なパターンまで
- **実用性重視**: 実際の業務・創作活動で使用可能な実践的フレームワーク

---

## 📋 Claude Code自然言語マクロプログラミングの構文
```markdown
- `##` マークダウン見出し：順次実行するメインタスク
- `###` マークダウン見出し：Task toolを利用して並列実行されるサブタスク
- 条件分岐: 自然言語による条件指示（「...の場合は」「...に応じて」など）
- `{{variable_name}}`：結果参照
- 結果保存：「...を{{variable_name}}に保存してください」
- 永続化保存：「{{variable_name}}をfilename.jsonに保存して永続化してください」
- ファイル読み込み：「filename.jsonを読み込んで{{variable_name}}に設定してください」
- 外部モジュール実行：「filename.mdの実行をしてください」
- ツール使用：自然言語で指示（例：「Webで調べて」「ファイルを読んで」）
```
### 基本構造の解説

#### 順次実行（`##` 見出し）
タスクを定義し、上から下に順番に実行されます：

```markdown
## データ収集
## データ処理  
## 結果出力
```

#### 並列実行（`###` 見出し）
同一`##`セクション内の`###`は並列実行されます：

```markdown
## 分析処理
### 統計分析
### トレンド分析
### 異常検知
```

### 変数管理の特徴

自然言語による統一記法を採用している：

```markdown
# 結果保存
データを分析し、結果を{{analysis_result}}に保存してください。

# 結果参照  
{{analysis_result}}を基に報告書を作成してください。
```

### 制御構造

条件分岐は自然言語で柔軟に記述できます：

```markdown
## データ処理
{{file_size}}が1MB以上の場合は詳細分析を、
それ以外の場合は基本分析を実行してください。
```

### モジュール実行

外部モジュールファイルを呼び出すことで、モジュラー設計が可能です：

```markdown
## データ処理パイプライン
data_collection.mdの実行をしてください。
data_analysis.mdの実行をしてください。
report_generation.mdの実行をしてください。

## 条件付きモジュール実行
{{data_type}}に応じて以下を実行：
- テキストデータの場合：text_analysis.mdの実行をしてください
- 数値データの場合：numerical_analysis.mdの実行をしてください
```

**モジュール実行の利点**：
- **再利用性**: 共通処理を独立したモジュールとして管理
- **保守性**: 各モジュールを独立して開発・テスト可能
- **スケーラビリティ**: 大規模システムの構築が現実的
- **協働**: チーム開発での責任分担が容易

---

## 📚 基本構文サンプル集


### 1. 順次実行：Python学習ガイド作成

```markdown
## 基本情報収集
「Python入門」についてWebで調べ、初心者向けのポイント3つを{{basics}}に保存してください。

## 学習計画作成
{{basics}}を基に、1週間の学習スケジュールを{{schedule}}に保存してください。

## 最終ガイド作成
{{basics}}と{{schedule}}を組み合わせて「Python入門ガイド」を作成してください。
```

### 2. 並列実行：競合分析

```markdown
## 電気自動車市場分析
以下の3社を同時に調査してください：

### Tesla分析
Teslaの2024年の主要な戦略を調査し{{tesla}}に保存してください。

### BYD分析
BYDの市場シェアと特徴を調査し{{byd}}に保存してください。

### トヨタ分析
トヨタのEV戦略を調査し{{toyota}}に保存してください。

## 競合比較レポート
{{tesla}}、{{byd}}、{{toyota}}を比較した市場分析レポートを作成してください。
```

### 3. 条件分岐：ファイル処理システム

```markdown
## ファイル確認
README.mdファイルのサイズ（文字数）を確認し{{file_size}}に保存してください。

## 処理方式決定
{{file_size}}に応じて以下を実行：
- 100文字未満の場合：「簡潔なファイルです。全文を表示します」と出力し、全文を{{content}}に保存
- 100文字以上の場合：「詳細なファイルです。要約を作成します」と出力し、要約を{{content}}に保存

## 結果表示
{{content}}を使って適切な形式で結果を表示してください。
```

### 4. ファイル永続化：学習進捗管理

```markdown
## 今日の学習記録
今日学習した内容を「Claude Code基本操作」として{{today_study}}に保存し、
{{today_study}}をstudy_log.jsonに保存して永続化してください。

## 進捗確認
study_log.jsonを読み込んで{{study_history}}に設定し、
学習継続日数と内容をまとめて表示してください。
```

### 5. 統合例：市場調査システム

```markdown
## 調査準備
「AI市場動向」を調査テーマとして{{theme}}に保存してください。

## 並列情報収集
{{theme}}について以下を同時実行：

### 技術動向
最新のAI技術トレンドを{{tech_trends}}に保存してください。

### 市場規模
AI市場の規模と成長予測を{{market_size}}に保存してください。

### 企業動向
主要AI企業の戦略を{{company_strategies}}に保存してください。

## 条件付きレポート作成
{{tech_trends}}、{{market_size}}、{{company_strategies}}の完全性を確認し：
- 3つすべて収集できた場合：{{tech_trends}}、{{market_size}}、{{company_strategies}}を統合した包括的な市場分析レポートを作成
- 2つ以下の場合：利用可能な情報での基本レポートを作成し、不足部分を明記

## 結果保存
最終レポートをai_market_report.jsonに保存して永続化してください。
```

**全サンプルの特徴**：
- 即座に実行可能
- 具体的なテーマ使用
- 実在ファイル活用（README.md）
- 期待結果が明確

---

## 🔄 基本デザインパターン

### Pattern 1: Sequential Pipeline（順次パイプライン）

**概要**: データを段階的に処理する基本パターン。`収集→処理→出力`の線形フローで確実な結果を得る。

**処理フロー**: `入力 → 処理1 → 処理2 → 処理3 → 出力`

**適用判断**:
- ✅ 処理に明確な順序がある
- ✅ 前段階の結果が次段階の入力になる
- ✅ 各段階を独立してテスト・改善したい
- ❌ 各処理が完全に独立している（→Parallel Processingを検討）

**実用例：ブログ記事作成システム**
```markdown
## トピック調査
「リモートワークのメリット」についてWebで調べ、主要なポイント5つを{{research}}に保存してください。

## 構成作成
{{research}}を基に、読みやすいブログ記事の構成（見出し3-5個）を{{structure}}に保存してください。

## 記事執筆
{{structure}}に従って、1500文字程度のブログ記事を執筆し{{article}}に保存してください。

## 最終確認
{{article}}の文章を校正し、読みやすさと正確性を確認して最終版を作成してください。
```

**習得のポイント**: 各段階で前の結果を必ず活用する変数設計が重要である

---

### Pattern 2: Parallel Processing（並列処理）

**概要**: 独立したタスクを同時実行して効率化と多角的視点を実現。複数の専門家が異なる角度から同時にアプローチする状況をマクロ化。

**処理フロー**: `入力 → [タスクA, タスクB, タスクC] → 統合 → 出力`

**適用判断**:
- ✅ 各処理が互いに独立している
- ✅ 同一データに対する異なる視点の分析が必要
- ✅ 処理時間の短縮が重要
- ❌ 処理に厳密な順序がある（→Sequential Pipelineを検討）

**実用例：スマートフォン購入検討システム**
```markdown
## 検討対象設定
「2025年のスマートフォン購入」を検討テーマとして{{target}}に保存してください。

## 並列評価
{{target}}について以下を同時実行：

### 性能評価
処理速度、カメラ性能、バッテリー持続時間を評価し{{performance}}に保存してください。

### 価格評価
各機種の価格とコストパフォーマンスを評価し{{price}}に保存してください。

### ブランド評価
メーカーの信頼性とアフターサービスを評価し{{brand}}に保存してください。

## 購入推奨レポート
{{performance}}、{{price}}、{{brand}}を総合評価し、最適な機種を3つ推奨してください。
```

**習得のポイント**: 各並列タスクが独立していることを確認し、必ず統合段階を設けることが重要である

---

## 🎌 実践例解説：俳句生成マルチエージェントシステム

**ファイル**: [`haiku_direct.md`](./haiku_direct.md)

### システム概要

俳句生成マルチエージェントシステムは、**Sequential Pipeline**と**Parallel Processing**を組み合わせた実用的な例である。創作プロセスをマクロ化することで、一貫した品質の俳句を効率的に生成する。

### 🏗️ システム構造分析

#### Phase 1: Sequential Pipeline（順次実行）
```
テーマ生成 → 俳句並列作成 → 俳句評価・選択 → 最終レポート
```

**設計判断**: 各段階が前段階の結果に依存するため、Sequential Pipelineを採用

#### Phase 2: Parallel Processing（並列実行）
```
俳句並列作成セクション内：
├── Task 1: 第1テーマ俳句 (並列)
├── Task 2: 第2テーマ俳句 (並列)  
├── Task 3: 第3テーマ俳句 (並列)
└── Task 4: 第4テーマ俳句 (並列)
```

**設計判断**: 各俳句の作成は独立しているため、Parallel Processingで効率化

### 🔄 データフロー設計

**変数管理の巧妙な活用**：

1. **テーマ共有**: `{{themes}}` → 全ての並列タスクで共通利用
2. **個別結果**: `{{haiku_1}}`, `{{haiku_2}}`, `{{haiku_3}}`, `{{haiku_4}}` → 独立保存
3. **評価統合**: `{{best_selection}}` → 並列結果の統合評価
4. **最終出力**: 全変数を参照した包括的レポート

### 💡 学習ポイント

#### 1. パターンの適切な組み合わせ
- **外枠**: Sequential Pipeline（プロセス全体）
- **内部**: Parallel Processing（俳句生成部分）
- **全体**: 単一の統合されたシステム

#### 2. 変数設計の工夫
```markdown
# 共通入力変数
{{themes}} → 全並列タスクで使用

# 個別出力変数  
{{haiku_1}}, {{haiku_2}}, {{haiku_3}}, {{haiku_4}} → 各タスクの独立結果

# 統合変数
{{best_selection}} → 並列結果の評価・選択
```

#### 3. 実用的な品質管理
- **多様性確保**: 4つの異なるテーマで多角的アプローチ
- **客観評価**: 明確な評価基準による選択プロセス
- **包括記録**: 全工程の結果を最終レポートで保存

### 🎯 実装の特徴

#### 自然言語による直感的指示
```markdown
# 技術的でない、自然な表現
「5-7-5の音律構造に従い、テーマの奇妙さと独特さを表現してください」
「最も奇妙で印象的な俳句を選択してください」
```

#### 完全な自動化
- 人間の介入なしで完結
- 全プロセスが自動実行
- 一貫した品質の保証

### 📈 応用可能性

このシステム構造は以下の分野に応用可能である：

- **創作活動**: 小説、詩、キャッチコピー生成
- **コンテンツ制作**: 記事、プレゼン資料、企画書
- **意思決定支援**: 複数案の生成・評価・選択
- **品質保証**: 多角的検証による品質向上

### 🎓 学習効果

`haiku_direct.md`を理解することで以下が期待される：

1. **基本パターンの実践的組み合わせ**の習得
2. **変数管理の効果的な設計手法**の理解  
3. **実用的なシステム構築能力**の獲得
4. **自然言語マクロプログラミングの本質**の体得

このファイルは、基本パターンから実用システムへの**最良の架け橋**となる重要な学習教材である。

---

### Pattern 3: Conditional Execution（条件分岐）

**概要**: 状況に応じて異なる処理パスを動的に選択。データ特性やユーザー状況による最適な処理を実現し、柔軟で実用的なシステムを構築。

**処理フロー**: `入力 → 条件判定 → [処理A | 処理B | 処理C] → 出力`

**適用判断**:
- ✅ データや状況によって処理を変える必要がある
- ✅ エラーハンドリングや例外処理が重要
- ✅ ユーザー権限や設定による機能制御が必要
- ❌ 常に同じ処理で十分（→Sequential Pipelineを検討）

**実用例：曖昧要求解釈システム（自然言語曖昧性フォールバック）**
```markdown
## 曖昧要求の入力
以下のような意図的に曖昧な表現で要求を入力してください：
- 「AIについて調べて」
- 「教育への影響を知りたい」
- 「それについてもっと」

あなたの曖昧な要求を{{user_request}}に保存してください。

## 曖昧性レベル判定・解釈
{{user_request}}の曖昧性を判定し、解釈を{{interpretation}}に保存してください。

## 曖昧性に応じたフォールバック実行
{{user_request}}の曖昧性レベルに応じて：

高度な曖昧性の場合：
→ 「最も可能性の高い解釈として調査します」と推測実行
→ 「高度な推測による解釈です」を{{uncertainty_note}}に記録

中程度の曖昧性の場合：
→ 「文脈から推測して調査します」と部分推測実行
→ 「部分的推測を含みます」を{{interpretation_note}}に記録

## 曖昧性処理結果の体験
推測の妥当性、フォールバック価値、透明性を確認し、
自然言語曖昧性フォールバックを実体験してください。
```

**習得のポイント**: 全ての条件パターンを網羅し、明確な判定基準を設定することが重要である

---

## 🛡️ Graceful Degradation（優雅な機能低下）

**概要**: 理想的な条件を満たせない場合でも完全停止せず、段階的に品質を調整して可能な限りの価値を提供する設計原則。自然言語マクロの堅牢性を支える核心概念。

### 📋 核心原則

**4段階フォールバック戦略**: `理想 → 代替 → 最小 → エラー対応`

1. **部分価値の提供**: 完璧でなくても有用な結果を提供
2. **透明性の確保**: 制限事項を明確にユーザーに伝達
3. **段階的適応**: 状況に応じた品質レベルの調整
4. **回復可能性**: 条件改善時の自動復旧

### 🔧 実用例：適応型レポート生成システム

```markdown
## リソース状況確認
Web検索、データベース、専門資料の利用可能性を確認し{{resources}}に保存してください。

## 適応的レポート生成
{{resources}}に基づいて以下を実行：

完全リソース利用可能の場合：
→ 最新データ、専門分析、詳細な予測を含む包括的レポートを作成し{{full_report}}に保存してください

Web検索のみ利用可能の場合：
→ 公開情報に基づく基本レポートを作成し{{basic_report}}に保存してください
→ 「公開情報のみに基づく分析です。専門データは含まれていません」を{{limitation}}に記録してください

リソース大幅制限の場合：
→ 一般的な概要と分析フレームワークを提供し{{framework}}に保存してください
→ 「制約により概要レベルです。詳細化には追加リソースが必要です」を{{status}}に記録してください

## 品質レベル明示
作成されたレポート（{{full_report}}、{{basic_report}}、または{{framework}}）のレベルを明示し、
制限事項（{{limitation}}または{{status}}）と改善方法を説明してください。
```

**設計のポイント**：
- ❌ 「データ不足で処理できません」
- ✅ 「限定的データですが、以下の傾向が確認できます」+ 改善提案

この原則により、自然言語マクロシステムは**あらゆる状況で価値を提供**できる実用的なツールとなる。

---

## 📁 実践サンプル集

基本3パターンの詳細な実践例を以下で学習できる：

### 🔄 Sequential Pipeline（順次パイプライン）
- **初級**: [ブログ記事作成システム](./examples/sequential/blog_creation.md) - テーマ設定から校正まで
- **中級**: [学術調査パイプライン](./examples/sequential/research_pipeline.md) - 仮説構築から論文執筆まで

### ⚡ Parallel Processing（並列処理）
- **初級**: [市場分析システム](./examples/parallel/market_analysis.md) - 技術・市場・競合の同時調査
- **中級**: [競合調査システム](./examples/parallel/competitive_research.md) - 5社の並列企業分析

### 🎌 Conditional Execution（条件分岐）
- **初級**: [適応型学習システム](./examples/conditional/adaptive_tutor.md) - レベル別カリキュラム提供
- **中級**: [曖昧要求解釈システム](./examples/conditional/content_processor.md) - 自然言語曖昧性フォールバック


---

## 🎯 基本パターン習得完了

これで**基本3パターン**の習得が完了した：

1. **Sequential Pipeline**: 順序のある処理の基礎
2. **Parallel Processing**: 効率化と多角的視点  
3. **Conditional Execution**: 柔軟性と堅牢性

この3つのパターンを組み合わせることで、**多くの業務ニーズ**をカバーする実用的なシステムを構築できる。上記6つの実践サンプル（各パターン初級・中級）で段階的に学習を深めることで、自然言語マクロプログラミングの実践的な活用能力を身につけることができる。
